暗物质粒子探测卫星BGO量能器地面测试软件的设计
马思源1,2 ，封常青1,2，刘树彬1,2，安琪1,2
(1.	核探测与核电子学国家重点实验室，中国科学技术大学，合肥 230026；2.中国科学技术大学近代物理系，合肥 230026；)

摘要：BGO量能器作为暗物质粒子探测卫星的关键子探测器，在其实验室研制及工程化生产过程中均需要进行大量测试，包括初样鉴定件、正样飞行件共计40块前端电子学板的性能测试，初、正样共计约1600个光电倍增管的LED光源刻度测试，以及初、正样单机长达数月的多项地面环境模拟试验。本论文针对以上测试和试验过程中的数据采集和自动化控制的需求，设计并完成了一个基于LabWindows/CVI开发平台和虚拟仪器技术的自动化测试软件，并投入实际应用，保证了暗物质粒子探测卫星BGO量能器工程研制和生产的顺利进行。
  关键词：LabWindows/CVI；虚拟仪器；BGO量能器；暗物质粒子探测卫星
中图分类号： TL8  		文献标志码：A			文章编号：

 
暗物质粒子探测卫星（DAMPE）是中国科学院空间科学先导专项的首批卫星之一，其主要科学目标是通过观测高能电子和伽马射线来间接寻找暗物质粒子。作为DAMPE的关键探测器，BGO量能器用来测量入射粒子和射线的能量。在其实验室研制及工程化生产过程中均需要进行大量测试，包括初样鉴定件、正样飞行件共计40块前端电子学板的性能测试，初、正样共计约1600个光电倍增管的LED光源刻度测试，以及初、正样单机长达数月的多项地面环境模拟试验。这些工作如果由手工完成将耗费巨大人力，因此本论文针对以上测试和试验过程中的数据采集和自动化控制的需求，设计并完成了一个基于LabWindows/CVI开发平台和虚拟仪器技术的自动化测试软件，并投入实际应用，保证了暗物质粒子探测卫星BGO量能器工程研制和生产的顺利进行。
2.BGO量能器测试的软件需求
2.1  FEE的工程化生产
FEE-A、FEE-B分别有144路，FEE-C有72路信号输入通道，初样和正样一共需要调试20块A型板、10块B型板和10块C型板，共5040路通道，每一路通道都需要进行刻度扫描测试和信号源扫描测试，以确定每路通道的线性。若每个通道需要扫描80个测试点，则共需要403200个测试点。由于FEE-A还需要输出击中信号，有96路通道需要参与判选，因此需要对每一路的阈值功能进行测试，共需要进行1920次测试。这些工作如果由手工完成将耗费大量人力，为快速测得所有FEE通道的性能指标，亟待设计一个自动测试软件。
2.2 PMT批量测试
探测器使用了PMT进行多打拿极读出，初样正样中一共需要对约1600个PMT的性能进行检测并标定其动态范围，每个PMT需要测试90个点，总共有144000个测试点。为此闪烁晶体荧光模拟器被设计出来用于PMT的测试，需要设计自动化的软件来完成测试工作。

2.3 BGO量能器地面环境模拟试验
根据工程要求，BGO量能器在正式交付前需要进行单机环境测试，主要包括力学试验、EMC试验、常压热循环试验、真空热试验（包括热平衡和真空热循环）、及老炼试验。温度循环实验需要持续10天，老炼试验需要持续10天，热真空实验需要持续15天，加上前后准备工作共计近两个月。测试过程中BGO量能器需要持续工作，因此对于软件的稳定性有严格要求。由于过程中需要定期提醒值班人员记录供电模块参数等信息，因此软件需要具备定期提醒功能和报警功能。
3.框架设计
3.1硬件框架
为模拟数管对量能器的控制，在FEE调试和地面环境模拟试验中采用了由上位机控制的地检数据管理板(GDM)来收发指令和采集科学数据，GDM负责汇总量能器的16个FEE的电荷测量数据以及其中8块FEE-A的击中信号，并产生触发信号给FEE以控制其采集数据。GDM通过USB总线和RS422总线和上位机相连，具体结构如下图所示：
 
  

3.2 软件框架
LabWindows/CVI是美国NI（National Instruments）公司利用虚拟仪器技术开发的面向计算机测控领域的软件开发平台，越来越广泛地应用于各种测控仪器仪表的开发。它是一个ANSC C的集成开发环境，将使用灵活的C语言平台与用于数据采集、分析和表达的测控专业工具有机地结合起来。利用其集成化开发环境、交互式编程方法和函数面板，大大增强了C语言的功能，并集成了GPIB、VX、VISA、TCP等函数库，为编写自动测试环境、数据采集系统，过程监控系统等应用软件提供了一个理想的开发环境。
本软件基于LabWindows/CVI平台开发，采用了模块化的结构，仔细考虑了接口需求和测试需求，设计了命令收发、数据获取等模块，基本软件框图如下：
 
  

命令控制模块通过RS-422接口连接GDM，负责对FEE发送指令，控制FEE的工作状态，同时将返回参数写入日志文件并将遥测状态显示于用户界面；数据获取模块由用户界面控制，通过USB接口从GDM获取采集到的科学数据，存入指定文件；信号发生器模块被用户界面的TA自检、信号源扫描和PMT测试等子模块控制，通过USB接口连接信号发生器和GDM，完成功能测试。
4.软件功能实现
4.1接口部分
本软件通过USB接口和RS-422接口连接硬件。
USB接口由GDM上的芯片CY68013驱动，实现与上位机的硬件连接，负责把科学数据由GDM传输给上位机，并将上位机对GDM的控制命令传输给GDM。传输方式在CY68013的固件中设置为批量（BULK）传输模式，并采用SLAVE FIFO的方式，保证了数据传输高速可靠。
同时，在信号源扫描测试和PMT测试中需要上位机通过USB接口对Tektronix AFG3252信号发生器进行控制。上位机通过虚拟仪器软件架构（Virtual instrument software architecture, VISA）来连接USB接口并控制GDM和信号源，所有相关控制函数都采用VISA所提供的函数进行处理。
RS-422接口在GDM上由FT230X芯片转换为USB接口，实现与上位机的硬件连接。在上位机软件里通过LabWindows/CVI自带函数库中OpenComConfig()来连接该接口，实现命令的发送和状态字的接收。
4.2 数据获取模块
FEE的科学数据传输至GDM，由GDM汇总并打包，添加包头包尾后通过USB接口传输到上位机，由软件负责读取。在软件中专门为读取科学数据开辟了一个线程，在线程中使用VISA库中的viRead()函数循环读取USB缓存中的数据，每次读取512Byte。读取到的数据会保存到事先指定的文件中，用以离线分析。同时为了对读取进度进行控制，软件会对数据量进行记录，每512Byte为一个数据包，每读取1000个数据包就会在用户界面的文本窗口显示数据包总量。若执行viRead()函数没有读取到数据，软件会在文本窗口显示“等待数据”，若连续20次没有读取到数据，软件会弹出提示窗口警告操作者。
数据采集完全通过USB接口进行，因此USB接口的状态非常重要，为此软件在数据采集过程中会专门开辟一个线程监测USB接口状态，在线程中周期性调用VISA库函数viFindRsrc()查找该USB设备，一旦该函数执行失败，则认为USB设备连接中断，此时软件会弹出窗口提示操作者USB设备出现问题。
用户界面的刻度扫描子模块通过数据获取模块控制GDM对最多16块FEE同时进行刻度扫描测试，用户只需要设置起始电压、终止电压和步长电压再点击Start_cali按钮，程序就会自动进行刻度扫描，刻度测试流程如下：
 
连接硬件，上电并初始化软件后开始刻度测试，设置刻度电压后开始刻度采集，采完一个电压点后自动开始下一个电压点的采集，全部完成后对所有通道的电荷-输出ADC码进行离线分析，得到每个通道的线性增益和非线性指标。图6为某通道的线性拟合结果。
 
4.3信号发生器控制模块
Tektronix AFG3252信号发生器自带USB芯片，上位机可通过VISA库函数实现对该信号发生器的控制。实际操作中，通过VISA库函数viFindRsrc()来定位该设备，通过viWrite()函数向信号发生器的USB端口写入规定格式的数据，即可控制信号发生器产生幅度和相位已知的信号。
从软件模块化的理念出发，控制信号发生器的一系列命令被设计成子函数的形式，以方便软件调用。
在信号源扫描测试中，只需要设置起始电压、终止电压和步长电压，软件即可自动控制信号发生器和GDM完成对FEE的信号源扫描。
在PMT测试中也只需要设置电压参数，软件即可控制信号源产生需要的信号进而控制驱动电路完成PMT测试。
4.4命令控制模块
在各项测试中，软件需要发送控制命令给FEE用以控制其工作状态。命令由4字节构成，加上包头包尾一共12字节，在软件中将命令以十六进制的形式存放于unsignedchar型数组中，使用CVI函数库中的ComWrt()函数将命令字通过RS-422接口发送至GDM，再由GDM发送至FEE。每次收到命令，FEE会返回状态参数，状态参数通过GDM传送回上位机，上位机通过函数ComRdByte()逐字节接收返回参数，存放于unsignedchar型数组中。为方便对FEE的控制，所有发送接收的指令都会实时显示在用户界面中的文本显示窗口。同时，为了追踪以往发送接收过的指令，在软件启动时会由用户指定一个文件夹用以存放指令日志文件(CMD_LOG)，软件在发送和接收指令时会同时把指令写入CMD_LOG，每次写入前会读取系统时间对指令进行标记，方便对每一条指令进行追查。常用指令被设计为子函数，方便调用。
由于FEE工程化生产和BGO量能器地面环境模拟试验中需要对FEE进行大块指令包注入，因此软件提供了批量参数配置模式。把所有需要注入的指令以4字节为单位提前写入二进制文件中，在使用时通过直接导入二进制文件，实现对FEE的快速配置。
在BGO量能器地面环境模拟试验中需要随时关注FEE的温度和电流信息，因此软件设计了一个遥测状态显示界面以方便值班人员随时观测遥测状态。软件中专门开发了一个线程，循环向FEE发送状态监测指令，返回状态字经过软件运算处理得到FEE的电流和温度数据，存入专门为此建立的文件内。同时在软件中定义了两个数组，分别存放实时返回的温度和电流数据，每当FEE的返回状态字到达时程序会自动查询命令类型，当确认是温度或电流遥测指令时，就会把状态字中的ADC码转化为温度或电流数据，按FEE编号存放于数组中。软件中开发了一个线程，每隔10秒会自动把温度数组和电流数组里存放的数据显示在遥测界面，实现了遥测状态的实时监测。图为热真空测试中的一个温度遥测界面，每个界面可以同时显示一小时内4个FEE中16个热敏电阻测得的温度信息。
 
4.5提醒和报警功能
在BGO量能器地面环境模拟试验中需要值班人员连续数天至数十天不间断地进行数据采集和状态监测，需要软件有报警功能和定时提醒功能。
在软件中专门开发一个线程用以实现这些功能，此线程内有一个定时器，每间隔2小时会触发一个回调函数，回调函数通过播放铃声和弹出提示窗口的方式提醒操作人员记录高压模块电流等关键数据。在此线程中还会循环地主动查询每个FEE的温度和电流参数，通过对比预先设置的阈值来判断量能器是否工作在正常状态，当温度或电流超过阈值就会以发出报警铃声的方式告知操作人员。
5 地面测试软件的应用实例
测试软件的用户面板如图所示，面板分为多个区域。状态显示区域用于监测GDM与上位机的连接状态，其文本窗口可以显示命令配置情况和数据采集进度；子窗口目录区域可以打开包括温度监测，值班模式在内的一系列子窗口，方便操作人员对探测器的状态进行监控；数据采集区域可以控制采集模式，包括正常模式和刻度模式，也可以对具体采集状态进行配置；命令区域可以人工发送指令给FEE，也可以进行模块化配置，同时也会把发送的命令和FEE返回状态字实时显示出来；触发配置区域负责对具体触发模式进行控制；基本连接区域负责初始化工作状态，包括连接相应的FEE，选择文件存储路径等。软件结合了各模块功能，设计了人性化的界面，有效提高了功能测试和地面模拟试验的效率。
 
  

6 结语
本软件使用了LabWindows/CVI开发平台，开发出了能够独立运行于测试PC机上的程序，具有数据采集、功能测试、状态监测和报警提醒的功能，满足了BGO量能器初样正和样中FEE的工程化生产，PMT测试及单机地面环境模拟试验的需要。该软件于2013年底开发、调试成功，2014年1月~2015年5月的使用过成功不断升级完善，对BGO量能器单机初样和正样的生产、测试具有重要意义，极大地提高了测试效率，减轻了测试人员和值班人员的工作强度，保证了BGO量能器的项目进度，目前BGO量能器正样件已经完成所有测试和地面试验，并已顺利交付。
参考文献：
[1] 黄亚齐，刘树彬，封常青，安琪.基于LabWindows/CVI的空间暗物质粒子探测预研系统的数据获取软件设计[J].核电子学与探测技术，2012，32(4)：407-411.
[2] 王建新，隋美丽.LabWindows/CVI虚拟仪器设计技术[M.北京：化学工业出版社，2013.
[3] Tektronix. TekVISA Programmer Manual, 071-1101-04, from www.tektronix.com.
[4] 郭建华，蔡明生，胡一鸣，常进.暗物质空间探测器BGO量能器的读出设计[J].天文学报，2012，53(1)：72-79.
[5] Cypress. EZ-USB Technical Reference Manual, from www.cypress.com.

